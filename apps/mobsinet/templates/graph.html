{% extends "base.html" %} {% block head %}

<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

<style>
  .node circle {
    fill: #69b3a2;
    stroke: #000;
    stroke-width: 1.5px;
  }

  .link {
    fill: none;
    stroke: #222;
    stroke-opacity: 0.6;
    stroke-width: 2px;
  }

  text {
    font-size: 12px;
    font-family: sans-serif;
  }

  body {
    font-family: Arial, sans-serif;
    background-color: #f4f4f9;
    margin: 0;
    padding: 0;
    color: #333;
  }

  .page-content {
    max-width: 1440px;
    margin: 0 auto;
    padding: 20px;
  }

  form {
    max-width: 1440px;
    margin: 20px auto;
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    padding: 20px;
  }

  fieldset {
    border: 1px solid #ccc;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 20px;
  }

  legend {
    font-weight: bold;
    padding: 0 10px;
  }

  label {
    display: block;
    margin-top: 10px;
    font-weight: bold;
  }

  input[type="text"],
  input[type="number"],
  select {
    width: 100%;
    padding: 10px;
    margin-top: 5px;
    border: 1px solid #ccc;
    border-radius: 5px;
    box-sizing: border-box;
  }

  button {
    background-color: #007bff;
    color: white;
    border: none;
    padding: 10px 15px;
    font-size: 16px;
    border-radius: 5px;
    cursor: pointer;
  }

  button:hover {
    background-color: #0056b3;
  }

  .info {
    display: inline-block;
    margin-left: 5px;
    font-size: 14px;
    color: #007bff;
    cursor: pointer;
  }

  .info:hover::after {
    content: attr(data-info);
    position: absolute;
    background: #333;
    color: #fff;
    padding: 5px 10px;
    border-radius: 5px;
    font-size: 12px;
    white-space: nowrap;
    transform: translate(-50%, -150%);
    z-index: 10;
    display: inline-block;
  }

  .button-group {
    display: flex;
    gap: 10px;
    margin-top: 20px;
  }

  .summary {
    margin-top: 20px;
    font-size: 16px;
    color: #555;
  }
</style>
<style>
  #page-title {
    text-align: center;
  }

  .node,
  .node-text {
    transition: cx 16ms linear, cy 16ms linear; /* Transição suave de 1 segundo */
  }

  #graph {
    width: 100vh;
    height: 100vh;
  }

  #runtime_container {
    display: flex;
    justify-content: center;
  }

  #runtime {
    display: flex;
    background-color: white;
    border-radius: 8px;
    padding: 20px 0px 0px 20px;
  }

  #runtime_panel {
    width: 500px;
  }

  @keyframes appear {
    0% {
      opacity: 0;
    }
    100% {
      opacity: 1;
    }
  }

  .confirmation-check {
    animation: appear 0.3s;
  }

  .two-nodes-algorithms-inputs-container {
    display: flex;
  }

  .networkx-icon {
    background-color: white;
    border-radius: 8px;
    padding: 2px;
  }
</style>

{% endblock head %} {% block title %} Graph Visualization {% endblock title %}
{% block header %}
<h1 id="page-title">Simulation Visualization</h1>
{% endblock header %} {% block content %}
<div class="page-content">
  <button onClick="toggleConfigurations()">Show/Hide configurations</button>
  <form
    id="options-form"
    enctype="application/x-www-form-urlencoded"
    method="post"
    action="{% url 'update_config' %}"
  >
    {% csrf_token %}

    <!-- Dropdown for projects -->
    <label for="project">Select Project:</label>
    <select id="project" name="project" onchange="changeProject()">
      {% for project in projects %}
      <option value="{{ project }}">{{ project }}</option>
      {% endfor %}
    </select>

    <fieldset>
      <!-- Top-level fields -->
      <label for="project_dir">PROJECT_DIR:</label>
      <input
        type="text"
        id="project_dir"
        name="PROJECT_DIR"
        value="{{ project_data.PROJECT_DIR }}"
      />

      <label for="simulation_name">Simulation Name:</label>
      <input
        type="text"
        id="simulation_name"
        name="simulation_name"
        value="{{ project_data.simulation_name }}"
      />

      <label for="num_nodes">Number of Nodes:</label>
      <input
        type="number"
        id="num_nodes"
        name="num_nodes"
        value="{{ project_data.num_nodes }}"
      />
    </fieldset>

    <fieldset>
      <label for="dimX">Dimension X:</label>
      <input
        type="number"
        id="dimX"
        name="dimX"
        value="{{ project_data.dimX }}"
      />

      <label for="dimY">Dimension Y:</label>
      <input
        type="number"
        id="dimY"
        name="dimY"
        value="{{ project_data.dimY }}"
      />

      <label for="dimZ">Dimension Z:</label>
      <input
        type="number"
        id="dimZ"
        name="dimZ"
        value="{{ project_data.dimZ }}"
      />
    </fieldset>

    <!-- Nested fields for network parameters -->
    <fieldset>
      <legend>Network Parameters:</legend>
      <label for="network_type">Type:</label>
      <input
        type="text"
        id="network_type"
        name="network_parameters[type]"
        value="{{ project_data.network_parameters.type }}"
      />

      <label for="avg_degree">Average Degree:</label>
      <input
        type="number"
        id="avg_degree"
        name="network_parameters[avg_degree]"
        value="{{ project_data.network_parameters.avg_degree }}"
      />
    </fieldset>

    <!-- node -->
    <label for="node">Node:</label>
    <input type="text" id="node" name="node" value="{{ project_data.node }}" />

    <!-- distribution_model -->

    <!-- Nested fields for distribution model parameters -->
    <fieldset>
      <legend>Distribution Model Parameters:</legend>

      <label for="distribution_model">Distribution Model:</label>
      <input
        type="text"
        id="distribution_model"
        name="distribution_model"
        value="{{ project_data.distribution_model }}"
      />
      <label for="orientation">Orientation:</label>
      <input
        type="text"
        id="orientation"
        name="distribution_model_parameters[orientation]"
        value="{{ project_data.distribution_model_parameters.orientation }}"
      />

      <label for="line_position">Line Position:</label>
      <input
        type="number"
        id="line_position"
        name="distribution_model_parameters[line_position]"
        value="{{ project_data.distribution_model_parameters.line_position }}"
      />

      <label for="number_of_nodes">Number of Nodes:</label>
      <input
        type="number"
        id="number_of_nodes"
        name="distribution_model_parameters[number_of_nodes]"
        value="{{ project_data.distribution_model_parameters.number_of_nodes }}"
      />

      <label for="midpoint">Midpoint:</label>
      <input
        type="text"
        id="midpoint"
        name="distribution_model_parameters[midpoint]"
        value="{{ project_data.distribution_model_parameters.midpoint|join:',' }}"
      />

      <label for="rotation_direction">Rotation Direction:</label>
      <input
        type="text"
        id="rotation_direction"
        name="distribution_model_parameters[rotation_direction]"
        value="{{ project_data.distribution_model_parameters.rotation_direction }}"
      />

      <label for="radius">Radius:</label>
      <input
        type="number"
        id="radius"
        name="distribution_model_parameters[radius]"
        value="{{ project_data.distribution_model_parameters.radius }}"
      />
    </fieldset>

    <!-- mobility_model -->

    <!-- mobility_model_parameters -->
    <fieldset>
      <legend>Mobility Model Parameters:</legend>

      <label for="mobility_model">Mobility Model:</label>
      <input
        type="text"
        id="mobility_model"
        name="mobility_model"
        value="{{ project_data.mobility_model }}"
      />
      <label for="speed_range">Speed Range:</label>
      <input
        type="text"
        id="speed_range"
        name="mobility_model_parameters[speed_range]"
        value="{{ project_data.mobility_model_parameters.speed_range|join:',' }}"
      />

      <label for="direction_range">Direction Range:</label>
      <input
        type="text"
        id="direction_range"
        name="mobility_model_parameters[direction_range]"
        value="{{ project_data.mobility_model_parameters.direction_range|join:',' }}"
      />

      <label for="prioritize_speed">Prioritize Speed:</label>

      <select
        id="prioritize_speed"
        name="mobility_model_parameters[prioritize_speed]"
      >
        <option
          value="true"
          {%
          if
          project_data.mobility_model_parameters.prioritize_speed
          %}selected{%
          endif
          %}
        >
          Sim
        </option>
        <option
          value="false"
          {%
          if
          not
          project_data.mobility_model_parameters.prioritize_speed
          %}selected{%
          endif
          %}
        >
          Não
        </option>
      </select>

      <label for="travel_distance">Travel Distance:</label>
      <input
        type="number"
        id="travel_distance"
        name="mobility_model_parameters[travel_distance]"
        value="{{ project_data.mobility_model_parameters.travel_distance }}"
      />

      <label for="travel_time">Travel Time:</label>
      <input
        type="number"
        id="travel_time"
        name="mobility_model_parameters[travel_time]"
        value="{{ project_data.mobility_model_parameters.travel_time }}"
      />
    </fieldset>

    <!-- Connectivity Model -->

    <fieldset>
      <legend>Connectivity Model Parameters:</legend>
      <label for="connectivity_model">Connectivity Model:</label>
      <input
        type="text"
        id="connectivity_model"
        name="connectivity_model"
        value="{{ project_data.connectivity_model }}"
      />
      <label for="max_radius">Max Radius:</label>
      <input
        type="number"
        id="max_radius"
        name="connectivity_model_parameters[max_radius]"
        value="{{ project_data.connectivity_model_parameters.max_radius }}"
      />

      <label for="min_radius">Min Radius:</label>
      <input
        type="number"
        id="min_radius"
        name="connectivity_model_parameters[min_radius]"
        value="{{ project_data.connectivity_model_parameters.min_radius }}"
      />

      <label for="big_radius_probability">Big Radius Probability:</label>
      <input
        type="number"
        step="0.01"
        id="big_radius_probability"
        name="connectivity_model_parameters[big_radius_probability]"
        value="{{ project_data.connectivity_model_parameters.big_radius_probability }}"
      />
    </fieldset>

    <!-- Reliability Model -->

    <fieldset>
      <legend>Reliability Model Parameters:</legend>
      <!-- Nenhum parâmetro fornecido, mas o espaço está reservado -->
      <label for="reliability_model">Reliability Model:</label>
      <input
        type="text"
        id="reliability_model"
        name="reliability_model"
        value="{{ project_data.reliability_model }}"
      />
    </fieldset>

    <fieldset>
      <legend>Interference Model Parameters:</legend>
      <!-- Interference Model -->
      <label for="interference_model">Interference Model:</label>
      <input
        type="text"
        id="interference_model"
        name="interference_model"
        value="{{ project_data.interference_model }}"
      />
    </fieldset>

    <fieldset>
      <legend>Message Transmission Model Parameters:</legend>
      <!-- Message Transmission Model -->
      <label for="message_transmission_model"
        >Message Transmission Model:</label
      >
      <input
        type="text"
        id="message_transmission_model"
        name="message_transmission_model"
        value="{{ project_data.message_transmission_model }}"
      />
      <label for="constant_transmission_time"
        >Constant Transmission Time:</label
      >
      <input
        type="number"
        id="constant_transmission_time"
        name="message_transmission_model_parameters[constant_transmission_time]"
        value="{{ project_data.message_transmission_model_parameters.constant_transmission_time }}"
      />

      <label for="random_transmission_min_time"
        >Random Transmission Min Time:</label
      >
      <input
        type="number"
        id="random_transmission_min_time"
        name="message_transmission_model_parameters[random_transmission_min_time]"
        value="{{ project_data.message_transmission_model_parameters.random_transmission_min_time }}"
      />

      <label for="random_transmission_max_time"
        >Random Transmission Max Time:</label
      >
      <input
        type="number"
        id="random_transmission_max_time"
        name="message_transmission_model_parameters[random_transmission_max_time]"
        value="{{ project_data.message_transmission_model_parameters.random_transmission_max_time }}"
      />
    </fieldset>

    <button type="submit">Submit</button>
    <span id="submitted" class="confirmation-check">✓</span>
  </form>

  <div id="runtime_container">
    <div id="runtime">
      <div id="runtime_panel">
        <button onClick="initSimulation()">Inicializar</button>
        <span id="initialized" class="confirmation-check">✓</span>

        <label for="simulation_rounds">Rodadas</label>
        <input
          type="number"
          id="simulation_rounds"
          name="simulation_rounds"
          value="{{ project_data.simulation_rounds }}"
          placeholder="Rodadas"
        />

        <label for="simulation_refresh_rate"
          >Taxa de atualização (Rodadas por segundo) (0 para não haver
          limitação)</label
        >
        <input
          type="number"
          id="simulation_refresh_rate"
          name="simulation_refresh_rate"
          value="{{ project_data.simulation_refresh_rate }}"
          placeholder="Taxa de atualização"
        />

        <select
          id="GUI_refresh_rate"
          name="GUI_refresh_rate"
          onchange="changeGUIRefreshRate()"
        >
          <option value="1">1 fps</option>
          <option value="2">2 fps</option>
          <option value="5">5 fps</option>
          <option value="10">10 fps</option>
          <option value="24">24 fps</option>
          <option value="30">30 fps</option>
          <option value="50">50 fps</option>
          <option selected value="60">60 fps</option>
          <option value="75">75 fps</option>
          <option value="100">100 fps</option>
          <option value="120">120 fps</option>
          <option value="144">144 fps</option>
          <option value="200">200 fps</option>
        </select>

        <button onClick="runSimulation()">Rodar</button>
        <button onClick="stopSimulation()">Parar</button>
        <button onMouseDown="showArrows()" onMouseUp="hideArrows()">
          Mostrar setas
        </button>
        <button onMouseDown="showNodesIds()" onMouseUp="hideNodesIds()">
          Mostrar IDs
        </button>
        <div>Time: <span id="time"></span></div>
        <div>
          Mensagens nesta rodada: <span id="numberOfMessagesInThisRound"></span>
        </div>
        <div>
          Total de mensagens enviadas:
          <span id="numberOfMessagesOverAll"></span>
        </div>
        <div class="two-nodes-algorithms">
          <form id="two-nodes-algorithms-form">
            {% csrf_token %}
            <div class="two-nodes-algorithms-inputs-container">
              <div>
                <input
                  type="number"
                  id="two-nodes-algorithms-node-1"
                  name="two-nodes-algorithms-node-1"
                  placeholder="Nó 1"
                />
              </div>
              <div>
                <input
                  type="number"
                  id="two-nodes-algorithms-node-2"
                  name="two-nodes-algorithms-node-2"
                  placeholder="Nó 2"
                />
              </div>
            </div>
            <div>
              <input
                type="text"
                disabled
                id="two-nodes-algorithms-result"
                name="two-nodes-algorithms-result"
                placeholder="Result"
              />
            </div>
            <button type="button" onClick="calculateDistanceBetweenTwoNodes()">
              Distance
            </button>
            <button
              type="button"
              onClick="calculateNetworkxConnectivityBetweenTwoNodes()"
            >
              Connectivity
              <svg
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 128 128"
                class="networkx-icon"
                height="1em"
                width="1em"
              >
                <path
                  d="M78.075 69.24c9.505-3.51 14.51-13.887 11.182-23.173C85.93 36.78 75.526 32.098 66.022 35.61c-9.504 3.512-14.51 13.886-11.181 23.173 3.328 9.287 13.732 13.968 23.234 10.457z"
                  fill="#FF7F0E"
                />
                <path
                  d="M74.15 21.646a31.87 31.87 0 00-12.33 1.965c-16.292 6.02-24.966 23.912-19.213 39.963 5.753 16.051 23.804 24.134 40.096 18.114v-.003l.002-.001c16.29-6.02 24.964-23.908 19.211-39.96C97.602 29.687 86.37 22.133 74.15 21.647zm-.24 6.514c9.68.35 18.446 6.304 21.84 15.776 4.527 12.63-2.258 26.78-15.316 31.605v.002h-.002c-13.06 4.824-27.133-1.552-31.659-14.18-4.526-12.629 2.26-26.781 15.319-31.607a25.617 25.617 0 019.818-1.596zm18.162 63.276a17.792 17.792 0 00-6.892 1.095c-9.1 3.362-13.962 13.373-10.74 22.36 3.22 8.986 13.338 13.507 22.439 10.144 9.1-3.362 13.96-13.37 10.738-22.357-2.414-6.74-8.71-10.968-15.545-11.242zm-.172 4.656c5.02.177 9.552 3.261 11.309 8.166 2.345 6.54-1.164 13.878-7.953 16.387-6.791 2.509-14.065-.795-16.408-7.334-2.345-6.541 1.165-13.88 7.955-16.387a13.326 13.326 0 015.097-.832zM22.566 58.865a12.746 12.746 0 00-4.937.785c-6.518 2.41-9.999 9.578-7.692 16.014 2.308 6.436 9.555 9.679 16.073 7.27 6.517-2.41 9.998-9.578 7.691-16.014-1.73-4.827-6.238-7.858-11.135-8.055zm-.123 3.336c3.596.127 6.841 2.337 8.1 5.85 1.679 4.684-.835 9.939-5.697 11.736-4.862 1.797-10.073-.57-11.752-5.254-1.68-4.684.835-9.939 5.697-11.736a9.549 9.549 0 013.652-.596z"
                  fill="#2c7fb8"
                />
                <path
                  d="M42.54 60.773l-11.75 4.344 1.86 5.033 11.75-4.34zm42.542 16.543l-7.053 2.528 5.746 16.031 7.053-2.527zm25.965-74.795a12.89 12.89 0 00-9.076 3.317c-5.16 4.653-5.65 12.575-1.02 17.607 4.632 5.033 12.6 5.281 17.758.627 5.159-4.652 5.651-12.573 1.02-17.605-2.316-2.516-5.467-3.836-8.682-3.946zm-.131 3.338c2.358.078 4.658 1.048 6.344 2.88 3.372 3.663 3.05 9.373-.797 12.843-3.846 3.47-9.671 3.255-13.043-.408-3.372-3.664-3.052-9.373.797-12.844a9.525 9.525 0 016.699-2.47z"
                  fill="#2c7fb8"
                />
                <path
                  d="M100.705 20.01L91.4 28.39l3.592 3.987 9.303-8.379zM62.568 95.434c-4.42-.722-8.685 2.24-9.527 6.627-.842 4.385 2.109 8.583 6.53 9.304 4.418.721 8.681-2.239 9.525-6.625v-.002c.84-4.384-2.109-8.583-6.528-9.304zm-.351 2.148h.002c3.263.534 5.36 3.522 4.74 6.746-.62 3.227-3.775 5.422-7.039 4.889-3.266-.533-5.362-3.521-4.742-6.746.62-3.227 3.774-5.42 7.039-4.889z"
                  fill="#2c7fb8"
                />
                <path
                  d="M68.037 102.771l-.56 3.438 7.937 1.293.56-3.438zM13.723 38.945a8.262 8.262 0 00-3.205.498c-4.236 1.549-6.512 6.194-5.03 10.377 1.483 4.183 6.179 6.302 10.414 4.752 4.233-1.548 6.507-6.191 5.026-10.373l.002-.002c-1.112-3.136-4.03-5.113-7.207-5.252zm-.088 2.164c2.332.09 4.434 1.53 5.244 3.813l-.002.002c1.08 3.044-.564 6.448-3.723 7.603-3.16 1.157-6.536-.39-7.615-3.435-1.08-3.045.564-6.448 3.725-7.604h.002a6.182 6.182 0 012.369-.379z"
                  fill="#2c7fb8"
                />
                <path
                  d="M17.078 52.713l-3.281 1.164 2.644 7.459 3.282-1.162zm98.07 9.139c-3.174-.07-6.27 1.707-7.726 4.738-1.966 4.02-.2 8.92 3.875 10.703 4.068 1.814 8.922.004 10.861-4.035 1.965-4.016.205-8.913-3.865-10.7h-.004a8.118 8.118 0 00-3.14-.706zm-.056 2.175a5.97 5.97 0 012.312.518l.008.002c2.95 1.29 4.23 4.822 2.791 7.758l-.004.008c-1.436 2.994-5.035 4.328-8.023 2.992l-.008-.004c-2.95-1.29-4.229-4.822-2.791-7.758l.004-.008c1.078-2.246 3.37-3.556 5.71-3.508z"
                  fill="#2c7fb8"
                />
                <path
                  d="M101.904 61.837l-1.922 3.178 7.29 3.26 1.421-3.178z"
                  fill="#2c7fb8"
                />
                <path
                  d="M93.914 116.833c4.549-1.681 6.945-6.648 5.351-11.092-1.594-4.446-6.572-6.686-11.121-5.005-4.549 1.68-6.945 6.647-5.353 11.091 1.594 4.446 6.574 6.686 11.121 5.006zM23.918 77.15c3.312-1.224 5.054-4.837 3.895-8.072-1.16-3.234-4.783-4.866-8.092-3.642-3.312 1.224-5.055 4.837-3.896 8.071 1.16 3.236 4.783 4.866 8.093 3.643zM112.44 20.8c3.31-1.223 5.054-4.837 3.894-8.07-1.16-3.236-4.782-4.866-8.092-3.643-3.311 1.223-5.054 4.837-3.896 8.072 1.16 3.235 4.783 4.866 8.094 3.642z"
                  fill="#FF7F0E"
                />
                <path
                  d="M109.979 76.111l-10.354 18 3.018 1.737 10.353-18z"
                  fill="#2c7fb8"
                />
              </svg>
            </button>
          </form>
        </div>
      </div>

      <div id="graph"></div>
    </div>
  </div>
</div>
<script>
  let running = false;
  let interval_update = null;
  let arrows = false;
  let showIds = false;
  let nodes = [];
  let links = [];

  async function renderGraph(
    round,
    numberOfMessagesInThisRound,
    numberOfMessagesOverAll
  ) {
    running = true;

    // Cria os dados para o scatter plot (nós)
    const nodeScatter = {
      x: nodes.map((node) => node.x),
      y: nodes.map((node) => node.y),
      text: nodes.map((node) => node.id),
      mode: showIds ? "markers+text" : "markers",
      marker: { size: 5, color: "blue", symbol: "circle" },
      type: "scatter",
      textposition: "top center",
    };

    // Obtém os limites do retângulo
    const dimX = Number(document.querySelector("#dimX").value);
    const dimY = Number(document.querySelector("#dimY").value);

    // Cria as bordas do retângulo
    const boundaryShapes = [
      {
        type: "line",
        x0: 0,
        y0: 0,
        x1: dimX,
        y1: 0,
        line: { color: "black", width: 1 },
      },
      {
        type: "line",
        x0: dimX,
        y0: 0,
        x1: dimX,
        y1: dimY,
        line: { color: "black", width: 1 },
      },
      {
        type: "line",
        x0: dimX,
        y0: dimY,
        x1: 0,
        y1: dimY,
        line: { color: "black", width: 1 },
      },
      {
        type: "line",
        x0: 0,
        y0: dimY,
        x1: 0,
        y1: 0,
        line: { color: "black", width: 1 },
      },
    ];

    // Obtém o estado atual do gráfico (eixos)
    const currentGraph = document.getElementById("graph");
    const currentLayout = currentGraph.layout ?? {
      xaxis: {
        range: [dimX * -0.1, dimX * 1.1],
        zeroline: false,
      },
      yaxis: {
        range: [dimY * -0.1, dimY * 1.1],
        zeroline: false,
      },
    };

    // Configurações do layout
    const layout = {
      xaxis: {
        range: currentLayout.xaxis.range,
        zeroline: false,
      },
      yaxis: {
        range: currentLayout.yaxis.range,
        zeroline: false,
      },
      shapes: [
        ...createEdgeShapes(
          nodes,
          links,
          numberOfMessagesInThisRound,
          currentLayout
        ),
        ...boundaryShapes,
      ], // Adiciona bordas e arestas
      showlegend: false,
    };

    const graph = document.getElementById("graph");

    // Renderiza o gráfico
    Plotly.react(graph, [nodeScatter], layout);

    document.getElementById("time").innerText = round;
    document.getElementById("numberOfMessagesInThisRound").innerText =
      numberOfMessagesInThisRound;
    document.getElementById("numberOfMessagesOverAll").innerText =
      numberOfMessagesOverAll;
    running = false;
  }

  // Função para criar as arestas como shapes (linhas com setas)
  function createEdgeShapes(
    nodes,
    links,
    numberOfMessagesInThisRound,
    currentLayout
  ) {
    const shapes = [];
    const arrowDegrees = Math.PI / 12;
    if (!currentLayout) return shapes;

    links.forEach((link, index) => {
      const filteredNodes = nodes.filter(
        (node) => node.id === link.source || node.id === link.target
      );
      const sourceNode = filteredNodes.find((node) => node.id === link.source);
      const targetNode = filteredNodes.find((node) => node.id === link.target);

      if (sourceNode && targetNode) {
        shapes.push({
          type: "line",
          id: `link-${link.source}-${link.target}`,
          x0: sourceNode.x,
          y0: sourceNode.y,
          x1: targetNode.x,
          y1: targetNode.y,
          line: {
            color: "#0000003a",
            width: 1,
          },
        });

        // Adiciona uma seta
        if (arrows) {
          const arrowSize =
            Math.min(
              Math.abs(
                currentLayout.xaxis.range[1] - currentLayout.xaxis.range[0]
              ),
              Math.abs(
                currentLayout.yaxis.range[1] - currentLayout.yaxis.range[0]
              ),
              Math.abs(
                Math.sqrt(
                  Math.pow(targetNode.x - sourceNode.x, 2) +
                    Math.pow(targetNode.y - sourceNode.y, 2)
                )
              ) * 10
            ) * 0.02;

          let angle = Math.atan2(
            targetNode.y - sourceNode.y,
            targetNode.x - sourceNode.x
          );
          shapes.push({
            type: "path",
            path: `M ${
              targetNode.x - arrowSize * Math.cos(angle - arrowDegrees)
            } ${targetNode.y - arrowSize * Math.sin(angle - arrowDegrees)}
              L ${targetNode.x - arrowSize * Math.cos(angle + arrowDegrees)} ${
              targetNode.y - arrowSize * Math.sin(angle + arrowDegrees)
            }
              L ${targetNode.x} ${targetNode.y}
              Z`,
            fillcolor: "#813131",
            line: {
              color: "#813131",
            },
          });
          if (link.bidirectional) {
            angle = angle + Math.PI;
            shapes.push({
              type: "path",
              path: `M ${
                sourceNode.x - arrowSize * Math.cos(angle - arrowDegrees)
              } ${sourceNode.y - arrowSize * Math.sin(angle - arrowDegrees)}
              L ${sourceNode.x} ${sourceNode.y}
              L ${sourceNode.x - arrowSize * Math.cos(angle + arrowDegrees)} ${
                sourceNode.y - arrowSize * Math.sin(angle + arrowDegrees)
              }
              Z`,
              fillcolor: "#813131",
              line: {
                color: "#813131",
              },
            });
          }
        }
      }
    });

    return shapes;
  }

  /*async function renderGraph(nodes, links, round, numberOfMessagesInThisRound,
    numberOfMessagesOverAll) {
    const svgns = "http://www.w3.org/2000/svg";
    const graph_svg = document.getElementById("graph_svg");

    const nodes_circles = nodes.map((node) => {
      const node_circle =
        graph_svg.getElementById("node-" + node.id) ||
        document.createElementNS(svgns, "circle");

      node_circle.setAttributeNS(null, "id", "node-" + node.id);
      node_circle.setAttributeNS(null, "class", "node");
      node_circle.setAttributeNS(null, "cx", node.x);
      node_circle.setAttributeNS(null, "cy", node.y);
      node_circle.setAttributeNS(null, "r", 20);
      node_circle.setAttributeNS(null, "fill", "blue");
      graph_svg.getElementById("node-" + node.id) ||
        graph_svg.append(node_circle);

      return node_circle;
    });

    old_drawed_link_lines = graph_svg.getElementsByClassName("link");

    for (const link_line of old_drawed_link_lines) {
      graph_svg.removeChild(link_line);
    }

    const link_lines = links.map((link) => {
      const link_line =
        graph_svg.getElementById("link-" + link.source + "-" + link.target) ||
        document.createElementNS(svgns, "line");

      source_node = nodes.find((node) => node.id === link.source);
      target_node = nodes.find((node) => node.id === link.target);

      link_line.setAttributeNS(
        null,
        "id",
        "link-" + link.source + "-" + link.target
      );
      link_line.setAttributeNS(null, "class", "link");
      link_line.setAttributeNS(null, "x1", source_node.x);
      link_line.setAttributeNS(null, "x2", target_node.x);
      link_line.setAttributeNS(null, "y1", source_node.y);
      link_line.setAttributeNS(null, "y2", target_node.y);
      link_line.setAttributeNS(null, "stroke-width", "10");
      link_line.setAttributeNS(null, "stroke", "black");

      graph_svg.getElementById("link-" + link.source + "-" + link.target) ||
        graph_svg.append(link_line);

      return link_line;
    });

    document.getElementById("time").innerText = round;
    document.getElementById("numberOfMessagesInThisRound").innerText =
      numberOfMessagesInThisRound;
    document.getElementById("numberOfMessagesOverAll").innerText =
      numberOfMessagesOverAll;
  }*/

  function wavelengthToRGB(wavelength) {
    /**
     * Convert a wavelength in nanometers to an approximate RGB color.
     */
    const gamma = 0.8;
    const intensityMax = 255;
    let factor = 0.0;
    let R = 0,
      G = 0,
      B = 0;

    if (wavelength >= 380 && wavelength < 440) {
      R = -(wavelength - 440) / (440 - 380);
      G = 0.0;
      B = 1.0;
    } else if (wavelength >= 440 && wavelength < 490) {
      R = 0.0;
      G = (wavelength - 440) / (490 - 440);
      B = 1.0;
    } else if (wavelength >= 490 && wavelength < 510) {
      R = 0.0;
      G = 1.0;
      B = -(wavelength - 510) / (510 - 490);
    } else if (wavelength >= 510 && wavelength < 580) {
      R = (wavelength - 510) / (580 - 510);
      G = 1.0;
      B = 0.0;
    } else if (wavelength >= 580 && wavelength < 645) {
      R = 1.0;
      G = -(wavelength - 645) / (645 - 580);
      B = 0.0;
    } else if (wavelength >= 645 && wavelength <= 750) {
      R = 1.0;
      G = 0.0;
      B = 0.0;
    } else {
      R = G = B = 0.0; // Wavelength outside visible range
    }

    // Adjust intensity
    if (wavelength >= 380 && wavelength < 420) {
      factor = 0.3 + (0.7 * (wavelength - 380)) / (420 - 380);
    } else if (wavelength >= 645 && wavelength <= 750) {
      factor = 0.3 + (0.7 * (750 - wavelength)) / (750 - 645);
    } else {
      factor = 1.0;
    }

    R = Math.round(intensityMax * Math.pow(R * factor, gamma));
    G = Math.round(intensityMax * Math.pow(G * factor, gamma));
    B = Math.round(intensityMax * Math.pow(B * factor, gamma));

    return [R, G, B];
  }

  function mapNumberToColor(value, minValue, maxValue) {
    // Normalize value to 0–1
    const normalized = (value - minValue) / (maxValue - minValue);
    // Map to wavelength
    const wavelength = 380 + normalized * (750 - 380);
    // Convert wavelength to RGB
    console.log(
      value,
      minValue,
      maxValue,
      wavelength,
      wavelengthToRGB(wavelength)
    );
    return wavelengthToRGB(wavelength)
      .map((c) => c.toString(16).padStart(2, "0"))
      .join("");
  }

  let chamadasHTTP = 0;
  let currentRound = -1;
  function getUpdatedGraph() {
    chamadasHTTP++;
    $.ajax({
      url: "update_graph/",
      type: "GET",
      success: function (data) {
        chamadasHTTP--;
        if (!data.n || !data.l) return clearInterval(interval_update);
        if (!data.r) clearInterval(interval_update);
        if (data.t < currentRound) return;

        if (!running) {
          running = true;

          let lastts = Date.now();
          currentRound = data.t;
          nodes = data.n.map(([id, x, y]) => ({ id, x, y }));
          links = data.l.map(([source, target, bidirectional]) => ({
            source,
            target,
            bidirectional,
          }));
          renderGraph(data.t, data.msg_r, data.msg_a);
          console.log("Tempo gasto pra renderizar", Date.now() - lastts, "ms");

          running = false;
        } else console.warn(running);
      },
    });
  }

  function intervalUpdate() {
    if (interval_update) clearInterval(interval_update);

    interval_update = setInterval(() => {
      if (chamadasHTTP < 2) getUpdatedGraph();
    }, 1000 / getSelectedGUIRefreshRate());
  }

  function showArrows() {
    arrows = true;
    getUpdatedGraph();
  }

  function hideArrows() {
    arrows = false;
    getUpdatedGraph();
  }

  function showNodesIds() {
    showIds = true;
    getUpdatedGraph();
  }

  function hideNodesIds() {
    showIds = false;
    getUpdatedGraph();
  }

  function toggleConfigurations() {
    $("#options-form").toggle();
  }

  function calculateDistanceBetweenTwoNodes() {
    const node1Id = $("#two-nodes-algorithms-node-1").val();
    const node2Id = $("#two-nodes-algorithms-node-2").val();
    const node1 = nodes.find((node) => node.id == node1Id);
    const node2 = nodes.find((node) => node.id == node2Id);

    const distance = Math.sqrt(
      Math.pow(node2.x - node1.x, 2) + Math.pow(node2.y - node1.y, 2)
    );
    console.log(distance);
    $("#two-nodes-algorithms-result").val(distance);
    console.log($("#two-nodes-algorithms-result"));
  }

  async function onReady() {
    intervalUpdate();

    $.ajax({
      url: "projects_names/",
      type: "GET",
      success: function (data) {},
      error: function (xhr, status, error) {
        console.error(error);
      },
    });

    initForm();

    // Adicionar evento de clique com botão direito
    const plotElement = document.getElementById("graph");
    plotElement.addEventListener("contextmenu", function (event) {
      // Prevenir o menu padrão do botão direito
      event.preventDefault();

      // Usar plotly_click para identificar o ponto
      plotElement.on("plotly_relayout", function (data) {
        console.log(data);
        if (data.points.length > 0) {
          const point = data.points[0];
          const x = point.x;
          const y = point.y;

          alert(`Você clicou com o botão direito no ponto: (x=${x}, y=${y})`);
        }
      });
    });

    $(".confirmation-check").hide();
    toggleConfigurations();
  }

  function getSelectedProject() {
    const select = document.querySelector("#project");
    const option = select.children[select.selectedIndex];

    return option.textContent;
  }

  function getSelectedGUIRefreshRate() {
    const select = document.querySelector("#GUI_refresh_rate");
    const option = select.children[select.selectedIndex];

    return Number(option.value);
  }

  function initForm() {
    const project = getSelectedProject();

    $.ajax({
      url: "get_config/?project=" + project,
      type: "GET",
      success: function (data) {
        console.log(data);
        populateForm(data);
      },
      error: function (xhr, status, error) {
        console.error(error);
      },
    });
  }

  $(document).ready(onReady);

  function initSimulation() {
    $.ajax({
      url: "init_simulation/?project=" + getSelectedProject(),
      type: "GET",
      success: function () {
        $("#initialized").show();
        setTimeout(() => {
          $("#initialized").hide();
        }, 2000);
        currentRound = -1;
        getUpdatedGraph();
      },
      error: function (xhr, status, error) {
        alert("Erro");
        console.error(error);
      },
    });
  }

  function runSimulation() {
    const rounds = document.querySelector("#simulation_rounds").value;
    let refreshRate = document.querySelector("#simulation_refresh_rate").value;

    if (!rounds) return alert('Preencha o campo "rodadas"');

    if (!refreshRate) refreshRate = 0;

    $.ajax({
      url: "run_simulation/?rounds=" + rounds + "&refresh_rate=" + refreshRate,
      type: "GET",
      success: function () {
        intervalUpdate();
      },
      error: function (xhr, status, error) {
        console.error(error);
      },
    });
  }

  function stopSimulation() {
    $.ajax({
      url: "stop_simulation/",
      type: "GET",
      success: function () {},
      error: function (xhr, status, error) {
        console.error(error);
      },
    });
  }

  function changeProject(e) {
    initForm();
  }

  function changeGUIRefreshRate(e) {
    intervalUpdate();
  }

  // Função que será executada quando o formulário for submetido
  document
    .getElementById("options-form")
    .addEventListener("submit", function (event) {
      // Impede o envio do formulário para poder processar os dados com JS
      event.preventDefault();

      // Serializa os dados do formulário
      const formData = $(this).serialize();

      $.ajax({
        url: $(this).attr("action"), // URL definida no atributo 'action' do formulário
        type: "POST", // Método HTTP
        data: formData, // Dados do formulário
        headers: {
          "X-CSRFToken": $('input[name="csrfmiddlewaretoken"]').val(), // Adiciona o CSRF token
        },
        success: function (response) {
          $("#submitted").show();
          setTimeout(() => {
            $("#submitted").hide();
          }, 2000);
        },
        error: function (xhr, status, error) {
          console.error("Erro ao enviar o formulário:", error);
          alert("Erro ao enviar o formulário.");
        },
      });
    });

  /**
   * Preenche o formulário com os valores do arquivo JSON.
   * @param {Object} jsonData - Dados do JSON a serem aplicados ao formulário.
   */
  function populateForm(jsonData) {
    const form = document.getElementById("options-form");

    Object.entries(jsonData).forEach(([key, value]) => {
      // Verifica se o valor é um objeto aninhado
      if (
        typeof value === "object" &&
        !Array.isArray(value) &&
        value !== null
      ) {
        Object.entries(value).forEach(([subKey, subValue]) => {
          const field = form.querySelector(`[name="${key}[${subKey}]"]`);
          if (field) {
            setFieldValue(field, subValue);
          }
        });
      } else {
        // Atualiza valores simples
        const field = form.querySelector(`[name="${key}"]`);
        if (field) {
          setFieldValue(field, value);
        }
      }
    });

    const field = document.querySelector(`[name="simulation_rounds"]`);

    setFieldValue(field, jsonData.simulation_rounds);
  }

  /**
   * Define o valor de um campo do formulário com base no tipo do campo.
   * @param {HTMLElement} field - Campo do formulário.
   * @param {any} value - Valor a ser aplicado ao campo.
   */
  function setFieldValue(field, value) {
    if (field.type === "checkbox") {
      field.checked = Boolean(value);
    } else if (field.type === "radio") {
      const radio = document.querySelector(
        `[name="${field.name}"][value="${value}"]`
      );
      if (radio) radio.checked = true;
    } else {
      field.value = value;
    }
  }
</script>

<script></script>

{% endblock content %}
